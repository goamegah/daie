name: CD - D√©ploiement Databricks

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de d√©ploiement'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod
      developer_name:
        description: 'Nom du d√©veloppeur (ex: godwin). Laisser vide pour "dev" par d√©faut.'
        required: false
        type: string
      skip_tests:
        description: 'Ignorer les tests (uniquement pour dev)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  CATALOG_PREFIX: 'daie_chn'

permissions:
  contents: read

jobs:
  test:
    name: Tests avant d√©ploiement
    runs-on: ubuntu-latest
    if: ${{ !(github.event.inputs.environment == 'dev' && github.event.inputs.skip_tests == 'true') }}
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Java (requis pour PySpark)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Installation des d√©pendances de test
        run: |
          python -m pip install --upgrade pip
          pip install -r test-requirements.txt

      - name: Installation du package
        run: pip install -e . --no-deps

      - name: Tests unitaires
        run: pytest tests/ -v

  build:
    name: Build du package
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Installation des d√©pendances (build)
        run: |
          python -m pip install --upgrade pip
          pip install build wheel

      - name: Build du package wheel
        run: python -m build

      - name: Upload des artefacts de build
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/
          retention-days: 7

  deploy:
    name: D√©ploiement Databricks
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.event.inputs.environment }}

    env:
      PYTHON_VERSION: '3.11'

      # Databricks
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}

      # Azure AD Service Principal
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

      # D√©ploiement
      ENV_NAME: ${{ github.event.inputs.environment }}
      DEVELOPER_NAME: ${{ github.event.inputs.developer_name || 'dev' }}
      CATALOG_PREFIX: 'daie_chn'

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download des artefacts de build
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: dist/

      # ‚úÖ Installer Databricks CLI v2
      - name: Install Databricks CLI v2
        run: |
          pip uninstall -y databricks-cli || true
          pip install --upgrade databricks databricks-sdk
          databricks --version

      # ‚úÖ Authentification Azure AD (Service Principal)
      - name: Authenticate to Databricks (Azure AD SP)
        run: |
          databricks auth login \
            --host "$DATABRICKS_HOST" \
            --client-id "$ARM_CLIENT_ID" \
            --client-secret "$ARM_CLIENT_SECRET" \
            --tenant-id "$ARM_TENANT_ID"

      # ‚úÖ Variables Unity Catalog
      - name: D√©finition des variables de d√©ploiement
        id: vars
        run: |
          BRONZE_CATALOG="${CATALOG_PREFIX}_${ENV_NAME}_bronze"
          SCHEMA_NAME="artifacts"
          VOLUME_NAME="packages_${DEVELOPER_NAME}"

          FULL_VOLUME_NAME="${BRONZE_CATALOG}.${SCHEMA_NAME}.${VOLUME_NAME}"

          echo "BRONZE_CATALOG=$BRONZE_CATALOG" >> $GITHUB_OUTPUT
          echo "FULL_VOLUME_NAME=$FULL_VOLUME_NAME" >> $GITHUB_OUTPUT

      - name: Affichage de la configuration
        run: |
          echo "=========================================="
          echo "üöÄ D√âPLOIEMENT DATABRICKS"
          echo "=========================================="
          echo "Environnement : ${{ env.ENV_NAME }}"
          echo "D√©veloppeur   : ${{ env.DEVELOPER_NAME }}"
          echo "Catalog       : ${{ steps.vars.outputs.BRONZE_CATALOG }}"
          echo "Volume UC     : ${{ steps.vars.outputs.FULL_VOLUME_NAME }}"
          echo "Host          : ${{ env.DATABRICKS_HOST }}"
          echo ""
          echo "üì¶ Packages :"
          ls -lh dist/
          echo "=========================================="

      # ‚úÖ Upload via Unity Catalog (CORRECT)
      - name: Upload du wheel vers Unity Catalog Volume
        run: |
          set -euo pipefail

          WHEEL_FILE=$(ls dist/*.whl | head -1)
          WHEEL_NAME=$(basename "$WHEEL_FILE")

          echo "üì§ Upload de $WHEEL_NAME"
          echo "‚û°Ô∏è  Volume : ${{ steps.vars.outputs.FULL_VOLUME_NAME }}"

          databricks volume upload \
            "${{ steps.vars.outputs.FULL_VOLUME_NAME }}" \
            "$WHEEL_FILE" \
            --overwrite

          echo ""
          echo "‚úÖ Upload termin√©"
          echo ""
          echo "üìù Installation dans Databricks :"
          echo "%pip install /Volumes/${{ steps.vars.outputs.FULL_VOLUME_NAME }}/$WHEEL_NAME"

      - name: V√©rification du contenu du volume
        continue-on-error: true
        run: |
          databricks volume list "${{ steps.vars.outputs.FULL_VOLUME_NAME }}"

      - name: R√©sum√© du d√©ploiement
        run: |
          echo "=========================================="
          echo "‚úÖ D√âPLOIEMENT TERMIN√â"
          echo "=========================================="
          echo "Environnement : ${{ env.ENV_NAME }}"
          echo "D√©veloppeur   : ${{ env.DEVELOPER_NAME }}"
          echo "Volume UC     : ${{ steps.vars.outputs.FULL_VOLUME_NAME }}"
          echo "Commit        : ${{ github.sha }}"
          echo "D√©clench√© par : ${{ github.actor }}"
          echo "=========================================="
