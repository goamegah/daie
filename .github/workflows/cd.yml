name: CD - D√©ploiement Databricks

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de d√©ploiement'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod
      developer_name:
        description: 'Nom du d√©veloppeur (ex: godwin). Laisser vide pour "dev" par d√©faut.'
        required: false
        type: string
      skip_tests:
        description: 'Ignorer les tests (uniquement pour dev)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  CATALOG_PREFIX: 'daie_chn'

permissions:
  contents: read

jobs:
  test:
    name: Tests avant d√©ploiement
    runs-on: ubuntu-latest
    if: ${{ !(github.event.inputs.environment == 'dev' && github.event.inputs.skip_tests == 'true') }}
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Java (requis pour PySpark)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Installation des d√©pendances de test
        run: |
          python -m pip install --upgrade pip
          pip install -r test-requirements.txt

      - name: Installation du package
        run: pip install -e . --no-deps

      - name: Tests unitaires
        run: pytest tests/ -v

  build:
    name: Build du package
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Installation des d√©pendances (build)
        run: |
          python -m pip install --upgrade pip
          pip install build wheel

      - name: Build du package wheel
        run: python -m build

      - name: Upload des artefacts de build
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/
          retention-days: 7

  deploy:
    name: D√©ploiement Databricks
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.event.inputs.environment }}
    env:
      # Configuration Databricks
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      # Service Principal credentials (depuis GitHub Secrets)
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      # Variables de d√©ploiement
      DEVELOPER_NAME: ${{ github.event.inputs.developer_name || 'dev' }}
      ENV_NAME: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download des artefacts de build
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: dist/

      - name: Installation de Databricks CLI
        run: pip install databricks-cli databricks-sdk

      - name: Configuration de Databricks CLI (Service Principal)
        run: |
          # Authentification via Service Principal (OAuth)
          # Le CLI utilise les variables d'environnement ARM_*
          echo "[DEFAULT]" > ~/.databrickscfg
          echo "host = ${{ env.DATABRICKS_HOST }}" >> ~/.databrickscfg
          
          # Obtenir un token OAuth via le Service Principal
          TOKEN=$(curl -s -X POST \
            "https://login.microsoftonline.com/${{ env.ARM_TENANT_ID }}/oauth2/v2.0/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=${{ env.ARM_CLIENT_ID }}" \
            -d "client_secret=${{ env.ARM_CLIENT_SECRET }}" \
            -d "scope=2ff814a6-3304-4ab8-85cb-cd0e6f879c1d/.default" \
            -d "grant_type=client_credentials" | jq -r '.access_token')
          
          echo "token = $TOKEN" >> ~/.databrickscfg
          
          echo "‚úÖ Authentification Service Principal configur√©e"

      - name: D√©finition des variables de d√©ploiement
        id: vars
        run: |
          # Catalog Bronze pour les artifacts
          BRONZE_CATALOG="${{ env.CATALOG_PREFIX }}_${{ env.ENV_NAME }}_bronze"
          
          # Chemin du volume pour les packages
          VOLUME_PATH="/Volumes/${BRONZE_CATALOG}/artifacts/packages/${{ env.DEVELOPER_NAME }}"
          
          echo "BRONZE_CATALOG=$BRONZE_CATALOG" >> $GITHUB_OUTPUT
          echo "VOLUME_PATH=$VOLUME_PATH" >> $GITHUB_OUTPUT

      - name: Affichage de l'environnement de d√©ploiement
        run: |
          echo "=========================================="
          echo "üöÄ CONFIGURATION DU D√âPLOIEMENT"
          echo "=========================================="
          echo "üë§ D√©clench√© par: ${{ github.actor }}"
          echo "üåø Branche: ${{ github.ref_name }}"
          echo "üè∑Ô∏è  D√©veloppeur: ${{ env.DEVELOPER_NAME }}"
          echo "üåç Environnement: ${{ env.ENV_NAME }}"
          echo ""
          echo "üì¶ Databricks Host: ${{ env.DATABRICKS_HOST }}"
          echo "üîê Auth: Service Principal"
          echo "ü•â Bronze Catalog: ${{ steps.vars.outputs.BRONZE_CATALOG }}"
          echo "üìÅ Volume Path: ${{ steps.vars.outputs.VOLUME_PATH }}"
          echo ""
          echo "üìã Packages √† d√©ployer:"
          ls -lh dist/
          echo "=========================================="

      - name: Upload du wheel vers Unity Catalog Volume
        run: |
          WHEEL_FILE=$(ls dist/*.whl | head -1)
          WHEEL_NAME=$(basename "$WHEEL_FILE")
          VOLUME_PATH="${{ steps.vars.outputs.VOLUME_PATH }}"
          echo "üì§ Upload de $WHEEL_NAME"
          echo "   Destination: $VOLUME_PATH/$WHEEL_NAME"
          databricks fs cp "$WHEEL_FILE" "dbfs:$VOLUME_PATH/$WHEEL_NAME" --overwrite
          STATUS=$?
          echo "Exit code: $STATUS"
          databricks fs ls "dbfs:$VOLUME_PATH"
          if [ $STATUS -ne 0 ]; then
            echo "Erreur lors de l'upload du package"
            exit $STATUS
          fi
          echo ""
          echo "‚úÖ Package upload√© avec succ√®s!"
          echo ""
          echo "üìù Pour installer ce package dans un notebook Databricks:"
          echo "   %pip install $VOLUME_PATH/$WHEEL_NAME"

      - name: V√©rification du d√©ploiement
        run: |
          VOLUME_PATH="${{ steps.vars.outputs.VOLUME_PATH }}"
          echo "üìã Contenu du volume:"
          databricks fs ls "dbfs:$VOLUME_PATH"
        continue-on-error: true

      - name: R√©sum√© du d√©ploiement
        run: |
          echo "=========================================="
          echo "‚úÖ D√âPLOIEMENT TERMIN√â"
          echo "=========================================="
          echo "Environnement: ${{ env.ENV_NAME }}"
          echo "D√©veloppeur: ${{ env.DEVELOPER_NAME }}"
          echo "Catalog: ${{ steps.vars.outputs.BRONZE_CATALOG }}"
          echo "Volume: ${{ steps.vars.outputs.VOLUME_PATH }}"
          echo "Branche: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Auth: Service Principal (${{ env.ARM_CLIENT_ID }})"
          echo "D√©clench√© par: ${{ github.actor }}"
          echo "=========================================="
#         id: vars
#         run: |
#           # Catalog Bronze pour les artifacts
#           BRONZE_CATALOG="${{ env.CATALOG_PREFIX }}_${{ env.ENV_NAME }}_bronze"
          
#           # Chemin du volume pour les packages
#           VOLUME_PATH="/Volumes/${BRONZE_CATALOG}/artifacts/packages/${{ env.DEVELOPER_NAME }}"
          
#           echo "BRONZE_CATALOG=$BRONZE_CATALOG" >> $GITHUB_OUTPUT
#           echo "VOLUME_PATH=$VOLUME_PATH" >> $GITHUB_OUTPUT

#       - name: Affichage de l'environnement de d√©ploiement
#         run: |
#           echo "=========================================="
#           echo "üöÄ CONFIGURATION DU D√âPLOIEMENT"
#           echo "=========================================="
#           echo "üë§ D√©clench√© par: ${{ github.actor }}"
#           echo "üåø Branche: ${{ github.ref_name }}"
#           echo "üè∑Ô∏è  D√©veloppeur: ${{ env.DEVELOPER_NAME }}"
#           echo "üåç Environnement: ${{ env.ENV_NAME }}"
#           echo ""
#           echo "üì¶ Databricks Host: ${{ env.DATABRICKS_HOST }}"
#           echo "üîê Auth: Service Principal"
#           echo "ü•â Bronze Catalog: ${{ steps.vars.outputs.BRONZE_CATALOG }}"
#           echo "üìÅ Volume Path: ${{ steps.vars.outputs.VOLUME_PATH }}"
#           echo ""
#           echo "üìã Packages √† d√©ployer:"
#           ls -lh dist/
#           echo "=========================================="

#       - name: Upload du wheel vers Unity Catalog Volume
#         run: |
#           WHEEL_FILE=$(ls dist/*.whl | head -1)
#           WHEEL_NAME=$(basename $WHEEL_FILE)
#           VOLUME_PATH="${{ steps.vars.outputs.VOLUME_PATH }}"
          
#           echo "üì§ Upload de $WHEEL_NAME"
#           echo "   Destination: $VOLUME_PATH/$WHEEL_NAME"
          
#           databricks fs cp "$WHEEL_FILE" "dbfs:$VOLUME_PATH/$WHEEL_NAME" --overwrite
          
#           echo ""
#           echo "‚úÖ Package upload√© avec succ√®s!"
#           echo ""
#           echo "üìù Pour installer ce package dans un notebook Databricks:"
#           echo "   %pip install $VOLUME_PATH/$WHEEL_NAME"

#       - name: V√©rification du d√©ploiement
#         run: |
#           VOLUME_PATH="${{ steps.vars.outputs.VOLUME_PATH }}"
#           echo "üìã Contenu du volume:"
#           databricks fs ls "dbfs:$VOLUME_PATH"
#         continue-on-error: true

#       - name: R√©sum√© du d√©ploiement
#         run: |
#           echo "=========================================="
#           echo "‚úÖ D√âPLOIEMENT TERMIN√â"
#           echo "=========================================="
#           echo "Environnement: ${{ env.ENV_NAME }}"
#           echo "D√©veloppeur: ${{ env.DEVELOPER_NAME }}"
#           echo "Catalog: ${{ steps.vars.outputs.BRONZE_CATALOG }}"
#           echo "Volume: ${{ steps.vars.outputs.VOLUME_PATH }}"
#           echo "Branche: ${{ github.ref_name }}"
#           echo "Commit: ${{ github.sha }}"
#           echo "Auth: Service Principal (${{ env.ARM_CLIENT_ID }})"
#           echo "D√©clench√© par: ${{ github.actor }}"
#           echo "=========================================="