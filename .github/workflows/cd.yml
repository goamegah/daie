name: CD - DÃ©ploiement Databricks

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de dÃ©ploiement'
        required: true
        default: 'dev'
        type: choice
        options: [dev, test, prod]

      developer_name:
        description: 'Nom du dÃ©veloppeur (ex: godwin)'
        required: false
        default: 'dev'
        type: string

      skip_tests:
        description: 'Ignorer les tests (uniquement pour dev)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  CATALOG_PREFIX: 'daie_chn'

permissions:
  contents: read

# ============================================================
# TESTS
# ============================================================
jobs:
  test:
    name: Tests avant dÃ©ploiement
    runs-on: ubuntu-latest
    if: ${{ !(github.event.inputs.environment == 'dev' && github.event.inputs.skip_tests == 'true') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Install test dependencies
        run: |
          pip install -U pip
          pip install -r test-requirements.txt
          pip install -e . --no-deps

      - name: Run tests
        run: pytest tests/ -v --cov=src --cov-report=term-missing

# ============================================================
# BUILD
# ============================================================
  build:
    name: Build Python package
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Build wheel package
        run: |
          pip install -U pip build wheel
          python -m build
          
          echo ""
          echo "ğŸ“¦ Package built:"
          ls -lh dist/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-wheel
          path: dist/*.whl
          retention-days: 7
          if-no-files-found: error

# ============================================================
# DEPLOY
# ============================================================
  deploy:
    name: DÃ©ploiement sur Databricks
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.event.inputs.environment }}

    env:
      ENV_NAME: ${{ github.event.inputs.environment }}
      DEVELOPER_NAME: ${{ github.event.inputs.developer_name }}
      
      # Variables Databricks (depuis GitHub Variables)
      DATABRICKS_HOST: ${{ vars.DATABRICKS_HOST }}
      
      # Authentification Azure AD Service Principal (depuis GitHub Secrets)
      DATABRICKS_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      DATABRICKS_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      DATABRICKS_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: python-wheel
          path: dist/

      # --------------------------------------------------------
      # Install Databricks SDK
      # --------------------------------------------------------
      - name: Install Databricks SDK
        run: |
          pip install -U pip
          pip install databricks-sdk
          
          echo ""
          echo "âœ… Databricks SDK installed"
          python -c "import databricks.sdk; print(f'Version: {databricks.sdk.__version__}')"

      # --------------------------------------------------------
      # Create Python deployment script
      # --------------------------------------------------------
      - name: Create deployment script
        run: |
          cat > deploy.py << 'EOF'
          #!/usr/bin/env python3
          """
          Script de dÃ©ploiement Databricks utilisant le SDK Python
          """
          import os
          import sys
          from pathlib import Path
          from databricks.sdk import WorkspaceClient
          from databricks.sdk.core import DatabricksError

          def main():
              # RÃ©cupÃ©rer les variables d'environnement
              host = os.getenv('DATABRICKS_HOST')
              client_id = os.getenv('DATABRICKS_CLIENT_ID')
              client_secret = os.getenv('DATABRICKS_CLIENT_SECRET')
              tenant_id = os.getenv('DATABRICKS_TENANT_ID')
              
              catalog = os.getenv('BRONZE_CATALOG')
              volume_path = os.getenv('VOLUME_PATH')
              wheel_file = os.getenv('WHEEL_FILE')
              wheel_name = os.getenv('WHEEL_NAME')
              
              print("ğŸ” Configuration:")
              print(f"   Host: {host}")
              print(f"   Client ID: {client_id[:8]}***")
              print(f"   Catalog: {catalog}")
              print(f"   Volume: {volume_path}")
              print(f"   Package: {wheel_name}")
              print()
              
              # Initialiser le client Databricks avec Azure SP
              print("ğŸ” Connecting to Databricks...")
              try:
                  w = WorkspaceClient(
                      host=host,
                      azure_client_id=client_id,
                      azure_client_secret=client_secret,
                      azure_tenant_id=tenant_id
                  )
                  
                  # Test de connexion
                  current_user = w.current_user.me()
                  print(f"âœ… Connected as: {current_user.user_name}")
                  print()
              except Exception as e:
                  print(f"âŒ Connection failed: {e}")
                  sys.exit(1)
              
              # CrÃ©er le rÃ©pertoire dans le volume
              print(f"ğŸ“ Creating directory: {volume_path}")
              try:
                  # Utiliser l'API Files pour crÃ©er le rÃ©pertoire
                  w.files.create_directory(volume_path)
                  print("âœ… Directory created")
              except DatabricksError as e:
                  if "RESOURCE_ALREADY_EXISTS" in str(e) or "already exists" in str(e).lower():
                      print("âš ï¸  Directory already exists, continuing...")
                  else:
                      print(f"âš ï¸  Directory creation warning: {e}")
              print()
              
              # Upload du wheel
              print(f"ğŸ“¤ Uploading {wheel_name}...")
              try:
                  wheel_path = Path(wheel_file)
                  destination = f"{volume_path}/{wheel_name}"
                  
                  with open(wheel_path, 'rb') as f:
                      content = f.read()
                  
                  # Upload avec l'API Files
                  w.files.upload(destination, content, overwrite=True)
                  
                  print(f"âœ… Upload successful: {destination}")
              except Exception as e:
                  print(f"âŒ Upload failed: {e}")
                  sys.exit(1)
              print()
              
              # VÃ©rification
              print("ğŸ” Verifying upload...")
              try:
                  files = list(w.files.list_directory_contents(volume_path))
                  print(f"âœ… Files in {volume_path}:")
                  for file in files:
                      print(f"   - {file.name} ({file.size} bytes)")
              except Exception as e:
                  print(f"âš ï¸  Verification warning: {e}")
              print()
              
              print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
              print("â•‘        âœ… DEPLOYMENT SUCCESSFUL                        â•‘")
              print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
              print()
              print("ğŸ“¦ To use this package in a Databricks notebook:")
              print()
              print(f"%pip install {volume_path}/{wheel_name}")
              print()

          if __name__ == "__main__":
              main()
          EOF
          
          chmod +x deploy.py
          
          echo "âœ… Deployment script created"

      # --------------------------------------------------------
      # Compute deployment variables
      # --------------------------------------------------------
      - name: Compute deployment variables
        id: vars
        run: |
          # DÃ©finir les variables de dÃ©ploiement
          BRONZE_CATALOG="${CATALOG_PREFIX}_${ENV_NAME}_bronze"
          VOLUME_BASE="/Volumes/${BRONZE_CATALOG}/artifacts/packages"
          VOLUME_PATH="${VOLUME_BASE}/${DEVELOPER_NAME}"
          
          # RÃ©cupÃ©rer le nom du wheel
          WHEEL_FILE=$(ls dist/*.whl | head -1)
          WHEEL_NAME=$(basename "$WHEEL_FILE")
          
          # Exporter les variables
          echo "BRONZE_CATALOG=${BRONZE_CATALOG}" >> $GITHUB_OUTPUT
          echo "VOLUME_PATH=${VOLUME_PATH}" >> $GITHUB_OUTPUT
          echo "WHEEL_FILE=${WHEEL_FILE}" >> $GITHUB_OUTPUT
          echo "WHEEL_NAME=${WHEEL_NAME}" >> $GITHUB_OUTPUT
          
          # Exporter pour le script Python
          echo "BRONZE_CATALOG=${BRONZE_CATALOG}" >> $GITHUB_ENV
          echo "VOLUME_PATH=${VOLUME_PATH}" >> $GITHUB_ENV
          echo "WHEEL_FILE=${WHEEL_FILE}" >> $GITHUB_ENV
          echo "WHEEL_NAME=${WHEEL_NAME}" >> $GITHUB_ENV
          
          # Afficher les informations
          echo ""
          echo "ğŸ“¦ Deployment variables:"
          echo "   Catalog: ${BRONZE_CATALOG}"
          echo "   Volume: ${VOLUME_PATH}"
          echo "   Package: ${WHEEL_NAME}"

      # --------------------------------------------------------
      # Execute deployment
      # --------------------------------------------------------
      - name: Deploy to Databricks
        run: |
          echo ""
          echo "ğŸš€ Starting deployment..."
          echo ""
          
          python deploy.py

      # --------------------------------------------------------
      # Deployment summary
      # --------------------------------------------------------
      - name: Deployment summary
        if: always()
        run: |
          WHEEL_NAME="${{ steps.vars.outputs.WHEEL_NAME }}"
          BRONZE_CATALOG="${{ steps.vars.outputs.BRONZE_CATALOG }}"
          VOLUME_PATH="${{ steps.vars.outputs.VOLUME_PATH }}"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        ğŸ“Š DEPLOYMENT SUMMARY                           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Configuration:"
          echo "   â€¢ Environment    : ${{ env.ENV_NAME }}"
          echo "   â€¢ Developer      : ${{ env.DEVELOPER_NAME }}"
          echo "   â€¢ Catalog        : ${BRONZE_CATALOG}"
          echo "   â€¢ Volume         : ${VOLUME_PATH}"
          echo "   â€¢ Package        : ${WHEEL_NAME}"
          echo ""
          echo "ğŸ”— Workspace:"
          echo "   â€¢ URL            : ${{ env.DATABRICKS_HOST }}"
          echo ""
          echo "ğŸ“ Git Info:"
          echo "   â€¢ Commit         : ${{ github.sha }}"
          echo "   â€¢ Branch         : ${{ github.ref_name }}"
          echo "   â€¢ Actor          : ${{ github.actor }}"
          echo ""

      # --------------------------------------------------------
      # Notification
      # --------------------------------------------------------
      - name: Send notification
        if: failure()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        âŒ DEPLOYMENT FAILED                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Check the logs above for more details."
          echo ""